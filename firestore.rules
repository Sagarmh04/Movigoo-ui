rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Events collection - public read, admin write only
    match /events/{eventId} {
      allow read: if true; // Public read for published/hosted events
      allow write: if false; // Only server API should write events
      
      // Event bookings - hosts can read their event bookings
      match /bookings/{bookingId} {
        allow read: if request.auth != null && (
          // User can read their own booking
          resource.data.userId == request.auth.uid ||
          // Host can read bookings for their events (check if user is host via organizerId or hostUid)
          get(/databases/$(database)/documents/events/$(eventId)).data.organizerId == request.auth.uid ||
          get(/databases/$(database)/documents/events/$(eventId)).data.hostUid == request.auth.uid ||
          // Admin can read all
          request.auth.token.admin == true
        );
        allow write: if false; // Only server API should write
      }
    }
    
    // User bookings - read own bookings, no client writes
    match /users/{uid}/bookings/{bookingId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // Only server API should write bookings
    }
    
    // Global bookings collection - admin read only
    match /bookings/{bookingId} {
      allow read: if request.auth != null && (
        // User can read their own booking
        resource.data.userId == request.auth.uid ||
        // Host can read bookings for their events (check organizerId or hostUid)
        get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.organizerId == request.auth.uid ||
        get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.hostUid == request.auth.uid ||
        // Admin can read all
        request.auth.token.admin == true
      );
      allow write: if false; // Only server API should write
    }
    
    // Payment sessions - no client access
    match /paymentSessions/{sessionId} {
      allow read: if false;
      allow write: if false; // Only server API should write
    }
    
    // Idempotency keys - no client access
    match /idempotency/{key} {
      allow read: if false;
      allow write: if false; // Only server API should write
    }
    
    // Users collection - read own profile, write own profile
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;
    }
    
    // Support tickets - user can read own tickets, create new tickets, but cannot modify status
    match /supportTickets/{ticketId} {
      // User can read their own tickets
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // User can create tickets (server API handles this, but allow for direct creation)
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.status == "OPEN" &&
        request.resource.data.priority == "NORMAL";
      // User cannot update or delete tickets (only admin/server can)
      allow update, delete: if false;
    }
    
    // Host analytics - read-only for hosts (writes only from server)
    match /host_analytics/{hostId} {
      // Host can read their own analytics
      allow read: if request.auth != null && request.auth.uid == hostId;
      // No client writes - only server API can write
      allow write: if false;
    }
    
    // Event analytics - read-only for hosts (writes only from server)
    match /event_analytics/{eventId} {
      // Host can read analytics for their events
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/events/$(eventId)).data.organizerId == request.auth.uid ||
        get(/databases/$(database)/documents/events/$(eventId)).data.hostUid == request.auth.uid ||
        request.auth.token.admin == true
      );
      // No client writes - only server API can write
      allow write: if false;
      
      // Event breakdown stats subcollection
      match /stats/{statId} {
        // Host can read stats for their events
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/events/$(eventId)).data.organizerId == request.auth.uid ||
          get(/databases/$(database)/documents/events/$(eventId)).data.hostUid == request.auth.uid ||
          request.auth.token.admin == true
        );
        // No client writes - only server API can write
        allow write: if false;
      }
    }
  }
}
